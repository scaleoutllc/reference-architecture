#!/usr/bin/env bash
# Compare two environments for differences.
set -euo pipefail
SCRIPT_PATH="$(cd "$(dirname "$BASH_SOURCE[0]")"; pwd -P)"

function usage {
  echo "Usage: $0 <team-env-providers-region> <team-env-providers-region>"
  exit 1
}

if test "$#" -ne 2; then
    usage
fi

IFS='-' read -r -a envA <<< "$1"
if [[ "${#envA[@]}" != 4 ]]; then
  echo "Please provide a valid environment name (e.g. fast-dev-aws-us)."
  exit 1
fi

IFS='-' read -r -a envB <<< "$2"
if [[ "${#envB[@]}" != 4 ]]; then
  echo "Please provide a valid environment name (e.g. fast-dev-aws-us)."
  exit 1
fi

A_PATH="${SCRIPT_PATH}/../infrastructure/environments/${envA[0]}/${envA[1]}/${envA[2]}/${envA[3]}"
if [[ ! -d "${A_PATH}" ]]; then
  echo "No environment found in ${A_PATH}."
  exit 1
fi

B_PATH="${SCRIPT_PATH}/../infrastructure/environments/${envB[0]}/${envB[1]}/${envB[2]}/${envB[3]}"
if [[ ! -d "${B_PATH}" ]]; then
  echo "No environment found in ${B_PATH}."
  exit 1
fi

A="$(find $A_PATH -type d -name '.*' -prune -o -type f ! -name '.*' -printf "%P\n" | sort)"
B="$(find $B_PATH -type d -name '.*' -prune -o -type f ! -name '.*' -printf "%P\n" | sort)"

echo "Files unique to $1:"
comm -23 <(echo "$A") <(echo "$B")

echo "Files unique to $2:"
comm -23 <(echo "$B") <(echo "$A")

echo "File comparison:"
for file in $(comm -12 <(echo "$A") <(echo "$B")); do
  diff "$A_PATH/$file" "$B_PATH/$file" || echo $file
done

